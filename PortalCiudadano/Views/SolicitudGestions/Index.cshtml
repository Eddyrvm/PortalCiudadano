@model IEnumerable<PortalCiudadano.Models.PortalGestion.SolicitudGestion>

@{
    ViewBag.Title = "Index";
}

<div class="card shadow-lg">
    <div class="card-header">
        <h5 class="card-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-building-gear" viewBox="0 0 16 16" style="margin-bottom: 4px;">
                <path d="M2 1a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6.5a.5.5 0 0 1-1 0V1H3v14h3v-2.5a.5.5 0 0 1 .5-.5H8v4H3a1 1 0 0 1-1-1z" />
                <path d="M4.5 2a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm3 0a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm3 0a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm-6 3a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm3 0a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm3 0a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm-6 3a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm3 0a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm4.386 1.46c.18-.613 1.048-.613 1.229 0l.043.148a.64.64 0 0 0 .921.382l.136-.074c.561-.306 1.175.308.87.869l-.075.136a.64.64 0 0 0 .382.92l.149.045c.612.18.612 1.048 0 1.229l-.15.043a.64.64 0 0 0-.38.921l.074.136c.305.561-.309 1.175-.87.87l-.136-.075a.64.64 0 0 0-.92.382l-.045.149c-.18.612-1.048.612-1.229 0l-.043-.15a.64.64 0 0 0-.921-.38l-.136.074c-.561.305-1.175-.309-.87-.87l.075-.136a.64.64 0 0 0-.382-.92l-.148-.045c-.613-.18-.613-1.048 0-1.229l.148-.043a.64.64 0 0 0 .382-.921l-.074-.136c-.306-.561.308-1.175.869-.87l.136.075a.64.64 0 0 0 .92-.382zM14 12.5a1.5 1.5 0 1 0-3 0 1.5 1.5 0 0 0 3 0" />
            </svg> Registro de gestión de solicitudes</h5>
        <div>
            <div class="row g-3 align-items-end">
                <div class="col-12 col-md-6">
                    <label for="searchBox" class="form-label text-secondary">Búsqueda por ciudadano:</label>
                    <input type="text" id="searchBox" name="search" placeholder="Buscar por Cédula, Apellidos o Nombres" class="form-control" />
                </div>

                <div class="col-12 col-md-6">
                    <label for="inputGroupSelect04" class="form-label text-secondary">Filtrar por Dirección:</label>
                    <div class="input-group">
                        <select class="form-select" id="inputGroupSelect04" aria-label="Seleccione un criterio de búsqueda">
                            <option value="" selected>[Elige un criterio de búsqueda]</option>
                            <option value="Participación Ciudadana">Participación Ciudadana</option>
                            <option value="Infraestructura Pública">Infraestructura Pública</option>
                            <option value="Servicios Públicos">Servicios Públicos</option>
                        </select>
                        <button class="btn btn-primary" id="btnFiltrar" type="button">Filtrar</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <div class="card-body">
        <p>
            @Html.ActionLink("Nueva solicitud", "Create", new { }, new { @class = "btn btn-success" })
        </p>
        <div id="tablaContainer">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Cédula</th>
                        <th>Usuario que Solicita</th>
                        <th>@Html.DisplayNameFor(model => model.FechaSolicitud)</th>
                        <th>Descripción de la solicitud</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    @foreach (var item in Model)
                    {

                        <tr>
                            <td>@Html.DisplayFor(modelItem => item.UsuarioSolicita.Cedula)</td>
                            <td>@Html.DisplayFor(modelItem => item.UsuarioSolicita.FullName)</td>
                            <td>@Html.DisplayFor(modelItem => item.FechaSolicitud)</td>
                            <td>@Html.DisplayFor(modelItem => item.SolicitudUsuario)</td>
                            <td>
                                <button class="btn btn-info btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_@item.SolicitudId" aria-expanded="false">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-list" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5" />
                                    </svg>
                                </button>
                                <a href="@Url.Action("Edit", "SolicitudGestions", new { id = item.SolicitudId })" class="btn btn-sm btn-outline-warning" title="Editar">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
                                        <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325" />
                                    </svg>
                                </a> 
                                <a href="@Url.Action("Details", "SolicitudGestions", new { id = item.SolicitudId })" class="btn btn-sm btn-outline-secondary" title="Detalles">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-square" viewBox="0 0 16 16">
                                        <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z" />
                                        <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0" />
                                    </svg>
                                </a>
                                <a href="@Url.Action("Delete", "SolicitudGestions", new { id = item.SolicitudId })" class="btn btn-sm btn-outline-danger" title="Eliminar">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z" />
                                        <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z" />
                                    </svg>
                                </a>

                            </td>
                        </tr>

                        <tr>
                            <td colspan="6">
                                <div class="collapse" id="collapse_@item.SolicitudId">
                                    <div class="card card-body">
                                        <div class="row">
                                            <div class="col-md-5">
                                                <strong>Observaciones:</strong> @Html.DisplayFor(modelItem => item.observaciones) <br>
                                                <strong>Usuario Atiende:</strong> @Html.DisplayFor(modelItem => item.QuienRegistraGestion) <br>
                                                <strong>Dirección:</strong> @Html.DisplayFor(modelItem => item.DireccionFuncionario) <br>
                                            </div>
                                            <div class="col-md-7 d-flex justify-content-center">
                                                <div class="row w-100">
                                                    <div class="col-md-3">
                                                        <strong>Foto 1:</strong> <br>
                                                        @if (!string.IsNullOrEmpty(item.Foto1))
                                                        {
                                                            <img src="@Url.Content(item.Foto1)" alt="Imagen" class="img-thumbnail modal-img" data-bs-toggle="modal" data-bs-target="#imageModal" data-img="@Url.Content(item.Foto1)" style="max-width: 100px; height: auto; border-radius: 10%; object-fit: cover; cursor: pointer;" />
                                                        }
                                                        <div class="col-md-1"></div>
                                                    </div>

                                                    <div class="col-md-3">
                                                        <strong>Foto 2:</strong> <br>
                                                        @if (!string.IsNullOrEmpty(item.Foto2))
                                                        {
                                                            <img src="@Url.Content(item.Foto2)" alt="Imagen" class="img-thumbnail modal-img" data-bs-toggle="modal" data-bs-target="#imageModal" data-img="@Url.Content(item.Foto2)" style="max-width: 100px; height: auto; border-radius: 10%; object-fit: cover; cursor: pointer;" />
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>

                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-body text-center p-0">
                <img src="" id="modalImage" class="img-fluid rounded" alt="Imagen completa" style="max-width: 90vw; max-height: 90vh; object-fit: contain;" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-modal" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
    $(document).ready(function(){
        $("#btnFiltrar").click(function(){
            var direccion = $("#inputGroupSelect04").val();
            // Redirige a la acción Index, enviando el parámetro "direccion"
            window.location.href = '@Url.Action("Index", "SolicitudGestions")' + "?direccion=" + encodeURIComponent(direccion);
        });
    });
    </script>

    <script>
        // Función para reconstruir la tabla a partir del JSON recibido
        function renderTable(data) {
            var tableBody = "";
            $.each(data, function (i, item) {
                // Fila principal con datos básicos y botones de acción
                tableBody += "<tr>";
                tableBody += "<td>" + item.Cedula + "</td>";
                tableBody += "<td>" + item.UsuarioSolicita + "</td>";
                tableBody += "<td>" + item.FechaSolicitud + "</td>";
                tableBody += "<td>" + item.SolicitudUsuario + "</td>";
                tableBody += "<td>";
                tableBody += "<button class='btn btn-info btn-sm' type='button' data-bs-toggle='collapse' data-bs-target='#collapse_" + item.SolicitudId + "' aria-expanded='false'>Más</button> ";
                tableBody += "<a href='@Url.Action("Edit", "SolicitudGestions")/" + item.SolicitudId + "'>Edit</a> | ";
                tableBody += "<a href='@Url.Action("Details", "SolicitudGestions")/" + item.SolicitudId + "'>Details</a> | ";
                tableBody += "<a href='@Url.Action("Delete", "SolicitudGestions")/" + item.SolicitudId + "'>Delete</a>";
                tableBody += "</td>";
                tableBody += "</tr>";

                // Fila con collapse para más detalles
                tableBody += "<tr>";
                tableBody += "<td colspan='6'>";
                tableBody += "<div class='collapse' id='collapse_" + item.SolicitudId + "'>";
                tableBody += "<div class='card card-body'>";
                tableBody += "<div class='row'>";
                tableBody += "<div class='col-md-5'>";
                tableBody += "<strong>Observaciones:</strong> " + item.Observaciones + " <br>";
                tableBody += "<strong>Usuario Atiende:</strong> " + item.QuienRegistraGestion + " <br>";
                tableBody += "<strong>Dirección:</strong> " + item.DireccionFuncionario + " <br>";
                tableBody += "</div>";
                tableBody += "<div class='col-md-7 d-flex justify-content-center'>";
                tableBody += "<div class='row w-100'>";
                tableBody += "<div class='col-md-3'>";
                tableBody += "<strong>Foto 1:</strong> <br>";
                if (item.Foto1) {
                    tableBody += "<img src='" + item.Foto1 + "' alt='Imagen' class='img-thumbnail modal-img' data-bs-toggle='modal' data-bs-target='#imageModal' data-img='" + item.Foto1 + "' style='max-width: 100px; height: auto; border-radius: 10%; object-fit: cover; cursor: pointer;' />";
                }
                tableBody += "</div>";

                tableBody += "<div class='col-md-3'>";
                tableBody += "<strong>Foto 2:</strong> <br>";

                if (item.Foto2) {
                    tableBody += "<img src='" + item.Foto2 + "' alt='Imagen' class='img-thumbnail modal-img' data-bs-toggle='modal' data-bs-target='#imageModal' data-img='" + item.Foto2 + "' style='max-width: 100px; height: auto; border-radius: 10%; object-fit: cover; cursor: pointer;' />";
                }
                tableBody += "</div>";
                tableBody += "</div>"; // row w-100
                tableBody += "</div>"; // col-md-7
                tableBody += "</div>"; // row
                tableBody += "</div>"; // card-body
                tableBody += "</div>"; // collapse
                tableBody += "</td>";
                tableBody += "</tr>";
            });
            $("#tableBody").html(tableBody);
        }

        // Función que realiza la petición AJAX
        function buscarSolicitudes(searchText) {
            $.ajax({
                url: '@Url.Action("Index", "SolicitudGestions")',
                type: 'GET',
                data: { search: searchText },
                success: function (result) {
                    // Se espera un arreglo JSON
                    if ($.isArray(result)) {
                        renderTable(result);
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error en la petición AJAX: " + error);
                }
            });
        }

        $(document).ready(function () {
            // En cada tecleo, si hay 3 o más caracteres o si se borra (cadena vacía), se hace la búsqueda AJAX.
            $("#searchBox").on("keyup", function () {
                var search = $(this).val();
                if (search.length >= 3 || search.length === 0) {
                    buscarSolicitudes(search);
                }
            });

            // Delegar el manejo del modal para las imágenes (se actualiza la imagen del modal según el data-img del elemento clickeado)
            $(document).on("click", ".modal-img", function () {
                var src = $(this).data("img");
                $("#modalImage").attr("src", src);
            });
        });
    </script>


    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".modal-img").forEach(img => {
                img.addEventListener("click", function () {
                    const imgSrc = this.getAttribute("data-img");
                    document.getElementById("modalImage").src = imgSrc;
                });
            });
            $(".close-modal").on("click", function () {
                $("#imageModal").modal("hide");
            });
        });
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
}
